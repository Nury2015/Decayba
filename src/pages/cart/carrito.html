<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Decayba ‚Äë Carrito</title>
    <link rel="stylesheet" href="../../assets/css/global.css" />
    <link rel="stylesheet" href="../../assets/css/carrito.css" />
    <link rel="stylesheet" href="../../assets/css/mobile.css" />
    <link rel="stylesheet" href="../../assets/css/header.css" />
    <link rel="stylesheet" href="../../assets/css/footer.css" />
    <link rel="stylesheet" href="../../assets/css/home.css" />
    <link rel="stylesheet" href="../../assets/css/cart.css" />
    <link rel="stylesheet" href="../../assets/css/tituloSugerencias.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- Contenedor del men√∫ hamburguesa -->
    <div id="contenedor-hamburguesa"></div>

    <!-- Contenedor del header global -->
    <div id="contenedor-menu"></div>
    <div id="toast" class="toast"></div>
    <nav id="header"></nav>

    <div class="contenedor-carrito">
      <div class="my-order" id="my-order">
        <div class="my-order-container">
          <p id="gracias-compra" class="gracias">¬°Gracias por tu compra üíñ!</p>
          <div class="cabecera">
            <h1 class="title">
              <div class="seleccionar-todo">
                <input
                  type="checkbox"
                  id="select-all"
                  style="margin-right: 10px"
                />
              </div>
              Total de art√≠culos
            </h1>
          </div>
          <div class="shopping-cart">
            <div class="list-shopping" id="list-shopping"></div>
          </div>
        </div>
      </div>
     
        
      <div class="order" id="resumen"></div>
      
    </div>

    <div class="my-order-content" id="sugerencia"></div>
    <h2 class="sugerencias-titulo">Algunas sugerencias para ti</h2>
    <div class="card-container" id="card-container"></div>

    <script>

      window.listaSeleccionados = [];
      document.addEventListener("DOMContentLoaded", () => {
        let cart = JSON.parse(localStorage.getItem("carrito")) || [];
  // Estado global
  let listaSeleccionados = [];
  let selectAllFlag = true; // iniciar con todo seleccionado
        const sugerencia = document.getElementById("sugerencia");
        const graciasCompra = document.getElementById("gracias-compra");
        const btnWhatsapp = document.getElementById("btn-whatsapp");
        const myOrder = document.getElementById("my-order");
        const listShopping = document.getElementById("list-shopping");
        const resumen = document.getElementById("resumen");
        const productosDisponibles =
          JSON.parse(localStorage.getItem("productosDisponibles")) || [];

    


 

    // --- Utilidades UI ---
    function showEmptyCart() {
      myOrder.style.display = "none";
      if (graciasCompra) graciasCompra.style.display = "none";
      return `
        <div style="text-align:center;margin-top:2rem;">
          <img src="../../assets/img/carritoVacio.png" alt="Carrito vac√≠o" style="max-width:100px;">
          <p>Tu carrito est√° vac√≠o</p>
        </div>`;
    }
    function showFullCart() {
      myOrder.style.display = "block";
      if (graciasCompra) graciasCompra.style.display = "block";
    }
    function actualizarCarritoVisual() {
      const cartCountDiv = document.querySelector(".navbar-shopping-cart div");
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
      const totalItems = carrito.reduce((acc, item) => acc + item.cantidad, 0);
      if (cartCountDiv) cartCountDiv.textContent = totalItems;
    }

    // --- Resumen basado SOLO en seleccionados ---
 function renderResumenSeleccionados() {
  const subtotal = listaSeleccionados.reduce(
    (acc, item) => acc + item.precio * item.cantidad,
    0
  );

  let envio = 0;
  let total = subtotal;

  if (subtotal > 0) {
    envio = subtotal >= 50000 ? 0 : 15000;
    total += envio;
  }

  resumen.innerHTML = `
  <h2 class="resumen-titulo"> Resumen del pedido üõçÔ∏è</h2>
    <div class="resumen-box">
      <p><strong>Subtotal:</strong> $${subtotal.toLocaleString()}</p>
      <p><strong>Env√≠o:</strong> $${envio.toLocaleString()}</p>
      <p><strong>Total:</strong> $${total.toLocaleString()}</p>
    </div>

    ${
      subtotal > 0
        ? `
        <div class="verificar">
          <a 
            href="https://wa.me/573154380079?text=Hola%2C%20quiero%20realizar%20mi%20pedido%20por%20un%20total%20de%20$${total.toLocaleString()}"
            target="_blank"
            class="btn-whatsapp"
            id="btn-whatsapp"
          >
            Ir a WhatsApp
          </a>
        </div>`
        : ""
    }
  `;
}


    // Mantener selecci√≥n consistente tras renders / cambios de carrito
    function reconcileSeleccionadosConCarrito() {
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
      const nombres = new Set(carrito.map(i => i.nombre));
      // Quita seleccionados que ya no existan
      listaSeleccionados = listaSeleccionados.filter(p => nombres.has(p.nombre));
      // Si select-all est√° activo, selecciona todo
      if (selectAllFlag) listaSeleccionados = [...carrito];
    }

    // Sincroniza checkboxes e "indeterminate" del select-all seg√∫n listaSeleccionados
    function syncCheckmarks() {
      const checkboxes = document.querySelectorAll('input[name="item"]');
      const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
      checkboxes.forEach(cb => {
        const idx = parseInt(cb.dataset.index);
        const item = carrito[idx];
        cb.checked = !!item && listaSeleccionados.some(p => p.nombre === item.nombre);
      });

      const selectAll = document.getElementById("select-all");
      if (selectAll) {
        const total = checkboxes.length;
        const sel = listaSeleccionados.length;
        selectAll.checked = total > 0 && sel === total;
        selectAll.indeterminate = sel > 0 && sel < total;
      }
    }

    // Render de un √≠tem
    function renderCartItem(item, index) {
      const subtotal = item.precio * item.cantidad;
      const itemElement = document.createElement("div");
      itemElement.classList.add("shopping-cart");

      const ruta = window.location.pathname;
      const rutaFinal =
        ruta.includes("index.html") || ruta === "/" || ruta.includes("Decayba")
          ? item.img.replace("../..", "./src")
          : item.img.replace("./src", "../..");

      itemElement.innerHTML = `
        <label class="label-product">   
          <input type="checkbox" name="item" value="${item.nombre}" data-index="${index}">
          <figure>
            <img src="${rutaFinal}" alt="${item.nombre}">
          </figure>
          <div class="inf-product">
            <p><strong>${item.nombre}</strong></p>
            <p>Subtotal: $${subtotal.toLocaleString()}</p>
            <small>($${item.precio.toLocaleString()} c/u √ó ${item.cantidad})</small>
          </div>
          <img src="../../../src/assets/icon/icon_close.png" alt="Eliminar" data-index="${index}" class="btn-remove">
        </label>
      `;
      listShopping.appendChild(itemElement);
    }

    // Render lista de √≠tems
    function renderItems() {
  const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
  listShopping.innerHTML = "";
  sugerencia.innerHTML = "";

  if (carrito.length === 0) {
    // Mostrar imagen carrito vac√≠o
    sugerencia.innerHTML = showEmptyCart();

    // Limpia selecci√≥n y resumen si queda vac√≠o
    listaSeleccionados = [];
    selectAllFlag = false;

    // Ocultar y limpiar resumen
    resumen.innerHTML = "";
    resumen.style.display = "none";

    return;
  }

  // Si hay productos, mostramos todo
  showFullCart();
  resumen.style.display = "block"; // aseguramos que reaparezca
  carrito.forEach((item, index) => renderCartItem(item, index));

  reconcileSeleccionadosConCarrito();
  syncCheckmarks();
  renderResumenSeleccionados();
}


    // --- Delegaci√≥n de eventos ---
    // Cambios en cada checkbox de producto
    document.addEventListener("change", (e) => {
      if (e.target && e.target.name === "item") {
        const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        const idx = parseInt(e.target.dataset.index);
        const item = carrito[idx];
        if (!item) return;

        if (e.target.checked) {
          if (!listaSeleccionados.some(p => p.nombre === item.nombre)) {
            listaSeleccionados.push({ ...item });
          }
        } else {
          listaSeleccionados = listaSeleccionados.filter(p => p.nombre !== item.nombre);
        }

        // Actualiza estado del select-all
        const total = document.querySelectorAll('input[name="item"]').length;
        selectAllFlag = (listaSeleccionados.length === total && total > 0);

        renderResumenSeleccionados();
        syncCheckmarks();
      }
    });

    // Seleccionar todo
    document.addEventListener("change", (e) => {
      if (e.target && e.target.id === "select-all") {
        const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        selectAllFlag = e.target.checked;
        listaSeleccionados = selectAllFlag ? [...carrito] : [];
        // Marcar visualmente todos
        document.querySelectorAll('input[name="item"]').forEach(cb => cb.checked = selectAllFlag);
        renderResumenSeleccionados();
        syncCheckmarks();
      }
    });

    // Agregar desde sugerencias (o donde uses .agregar-al-carrito)
    function setupAddToCartListeners() {
      document.addEventListener("click", function (event) {
        const addToCartBtn = event.target.closest(".agregar-al-carrito");
        if (!addToCartBtn) return;
        event.preventDefault();
        setTimeout(() => {
          renderItems();              // reconstruye la lista
          actualizarCarritoVisual();  // contador en header
        }, 100);
      });
    }

    // Eliminar con la X (asumiendo que tu l√≥gica de borrado ya actualiza localStorage)
    function setupRemoveListeners() {
      document.addEventListener("click", function (event) {
        const removeBtn = event.target.closest(".btn-remove");
        if (!removeBtn) return;
        event.preventDefault();
        setTimeout(() => {
          renderItems();              // reconstruye la lista
          actualizarCarritoVisual();  // contador en header
        }, 100);
      });
    }

    // WhatsApp (igual que lo ten√≠as, env√≠a TODO el carrito; si deseas, luego lo paso a solo seleccionados)
    document.addEventListener("click", function (e) {
      const target = e.target.closest("#btn-whatsapp");
      if (!target) return;

      e.preventDefault();
      const cart = JSON.parse(localStorage.getItem("carrito")) || [];
      const numero = "573154380079";

      if (cart.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
      }

      let mensaje = "üõçÔ∏è *Resumen de tu pedido* üíï\n\n";
      cart.forEach((item) => {
        const subtotal = item.precio * item.cantidad;
        mensaje += `*${item.nombre}*\nCantidad: ${item.cantidad}\nPrecio unitario: $${item.precio.toLocaleString()}\nSubtotal: $${subtotal.toLocaleString()}\n\n`;
      });

      const total = cart.reduce((acc, item) => acc + item.precio * item.cantidad, 0);
      mensaje += `üí∞ *Total a pagar:* $${total.toLocaleString()}\n\n‚úÖ Gracias por tu compra üíñ‚ú®`;

      const msg = encodeURIComponent(mensaje);
      window.open(`https://wa.me/${numero}?text=${msg}`, "_blank");
    });

    // --- Inicializaci√≥n ---
    renderItems();                // pinta la lista y selecciona todo de entrada
    setupAddToCartListeners();    // reacciona al agregar
    setupRemoveListeners();       // reacciona al eliminar
    actualizarCarritoVisual();    // contador del header

    // Desactivar bot√≥n si estamos en carrito.html (como lo ten√≠as)
    const carritoBtn = document.getElementById("ver-carrito");
    if (carritoBtn && window.location.pathname.includes("carrito.html")) {
      carritoBtn.removeAttribute("href");
      carritoBtn.style.pointerEvents = "none";
      carritoBtn.style.opacity = "0.5";
      carritoBtn.style.cursor = "not-allowed";
    }
  });
</script>


  <script type="module">
    async function inicializarPagina() {
      try {
        // 1. Cargar header PRIMERO
        const headerResponse = await fetch('/Decayba/src/components/headerglobal.html');
        const headerHtml = await headerResponse.text();
        document.getElementById('header').innerHTML = headerHtml;
        console.log('‚úÖ Header cargado');

        // 2. Cargar men√∫ hamburguesa
        const { cargarMenuHamburguesa } = await import('/Decayba/src/assets/js/modules/menu-loader.js');
        await cargarMenuHamburguesa();
        console.log('‚úÖ Men√∫ hamburguesa cargado');

        // 3. Inicializar aplicaci√≥n principal
        const { renderCart } = await import('/Decayba/src/assets/js/modules/renderCart.js');
        const { actualizarCarritoVisual } = await import('/Decayba/src/assets/js/modules/carrito.js');
        const { verDetalleProducto } = await import('/Decayba/src/assets/js/modules/detalleProducto.js');
        
        window.verDetalleProducto = verDetalleProducto;
        renderCart();
        actualizarCarritoVisual();
        
        console.log('‚úÖ P√°gina inicializada');
      } catch (error) {
        console.error('‚ùå Error al inicializar:', error);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarPagina);
    } else {
      inicializarPagina();
    }
  </script>
</body>
</html>